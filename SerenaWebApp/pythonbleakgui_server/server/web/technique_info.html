<!doctype html>
<html lang="nl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no" />
  <title>Techniek Details</title>
  <style>
    :root { 
        --bg: #0b0f14; --panel: #121821; --ink: #e9eef5; 
        --muted: #9db0c2; --accent: #4cc9f0; --ok: #6ee7a1; 
    }
    html, body { height: 100%; margin: 0; background: var(--bg); color: var(--ink); font-family: ui-sans-serif, system-ui, -apple-system, sans-serif; }
    .wrap { max-width: 800px; margin: 0 auto; padding: 20px; }

    /* Header & Back Button */
    header { display: flex; align-items: center; margin-bottom: 20px; }
    .btn-back {
        background: transparent; border: 1px solid var(--accent); color: var(--accent);
        border-radius: 6px; padding: 8px 16px; cursor: pointer; font-size: 14px;
        text-decoration: none; display: flex; align-items: center; gap: 8px;
        transition: background 0.2s;
    }
    .btn-back:hover { background: rgba(76, 201, 240, 0.1); }
    h1 { margin: 0 0 0 16px; font-size: 20px; font-weight: 300; flex-grow: 1; }

    /* Content Cards */
    .card { background: var(--panel); border: 1px solid #1f2835; border-radius: 12px; padding: 20px; margin-bottom: 16px; }
    
    h2 { margin-top: 0; font-size: 18px; color: var(--accent); margin-bottom: 10px; border-bottom: 1px solid #1f2835; padding-bottom: 8px; }
    p { line-height: 1.6; color: var(--muted); white-space: pre-wrap; margin-bottom: 0; }

    .protocol-table { width: 100%; border-collapse: collapse; margin-top: 10px; }
    .protocol-table th { text-align: left; color: var(--muted); font-size: 12px; border-bottom: 1px solid #333; padding: 8px; }
    .protocol-table td { padding: 8px; border-bottom: 1px solid #1f2835; color: var(--ink); font-family: monospace; font-size: 14px; }
    .total-row td { color: var(--ok); font-weight: bold; border-top: 1px solid #333; }

    .loader { text-align: center; color: var(--muted); margin-top: 40px; }
  </style>
</head>
<body>

<div class="wrap">
    <header>
        <a id="backLink" href="#" class="btn-back">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M19 12H5M12 19l-7-7 7-7"/></svg>
            Terug
        </a>
        <h1>Techniek Details</h1>
    </header>

    <div id="content">
        <div class="loader">Laden...</div>
    </div>
</div>

<script>

    // Haal parameters uit URL
    const params = new URLSearchParams(window.location.search);
    const techName = params.get('name');
    const deviceId = params.get('device');

    // Stel terug knop in
    const backLink = document.getElementById('backLink');
    let backUrl = "Serena.html"; 
    
    // Bouw de query string op
    const backParams = new URLSearchParams();
    if(deviceId && deviceId !== "UNKNOWN") {
        backParams.set('device', deviceId);
    }
    // NIEUW: Geef de technieknaam ook weer terug
    if(techName) {
        backParams.set('technique', techName);
    }

    const qs = backParams.toString();
    if(qs) backUrl += `?${qs}`;
    
    backLink.href = backUrl;

    async function loadDetails() {
        const contentDiv = document.getElementById('content');
        
        if (!techName) {
            contentDiv.innerHTML = '<div class="card"><p style="color:var(--bad)">Geen techniek geselecteerd.</p></div>';
            return;
        }

        try {
            // We halen ALLE technieken op (of public) en filteren
            const r = await fetch('/techniques/public');
            if(!r.ok) throw new Error("Server fout");
            const data = await r.json();
            
            const tech = data[techName];
            
            if (!tech) {
                contentDiv.innerHTML = `<div class="card"><p style="color:var(--warn)">Techniek '${techName}' niet gevonden.</p></div>`;
                return;
            }

            // HTML Bouwen
            let html = `
                <div class="card">
                    <h2>${techName}</h2>
                    <p>${tech.description || "Geen beschrijving beschikbaar."}</p>
                </div>
                
                <div class="card">
                    <h2>Protocol</h2>
                    <table class="protocol-table">
                        <thead>
                            <tr>
                                <th>In (s)</th>
                                <th>Hold (s)</th>
                                <th>Uit (s)</th>
                                <th>Hold (s)</th>
                                <th>Herhalingen</th>
                            </tr>
                        </thead>
                        <tbody>
            `;

            if (tech.protocol && tech.protocol.length > 0) {
                tech.protocol.forEach(row => {
                    const [cin, ch1, cout, ch2, rep] = row;
                    html += `
                        <tr>
                            <td>${cin}</td>
                            <td>${ch1}</td>
                            <td>${cout}</td>
                            <td>${ch2}</td>
                            <td>${rep}x</td>
                        </tr>
                    `;
                });
                
                // Bereken gemiddelde ademfrequentie van eerste regel (ter indicatie)
                const first = tech.protocol[0];
                const dur = first[0]+first[1]+first[2]+first[3];
                if(dur > 0) {
                    const bpm = (60/dur).toFixed(1);
                    html += `
                        <tr class="total-row">
                            <td colspan="5" style="text-align:right">Doelritme: ${bpm} ademhalingen/min</td>
                        </tr>
                    `;
                }
            } else {
                html += `<tr><td colspan="5">Geen protocol data.</td></tr>`;
            }

            html += `
                        </tbody>
                    </table>
                </div>
            `;
            
            contentDiv.innerHTML = html;

        } catch (e) {
            contentDiv.innerHTML = `<div class="card"><p style="color:var(--bad)">Fout bij laden: ${e.message}</p></div>`;
        }
    }

    loadDetails();
</script>

</body>
</html>